# BOM 시스템 양방향 동기화 구현 문서

## 프로젝트 개요
- **프로젝트명**: Multi-BOM Management System
- **작업일자**: 2024년
- **주요 작업**: 사이드바 트리와 데이터 그리드 간 양방향 동기화 구현

## 초기 문제점
1. **다크 테마 숫자 입력 문제**
   - 숫자 입력 시 텍스트가 보이지 않음
   - 키보드 이벤트 충돌로 숫자키 입력 불가

2. **행 위치 변경 버그**
   - 드래그로 행 위치 변경 후 원위치로 돌아가는 문제
   - 상태 저장이 되지 않음

3. **양방향 동기화 부재**
   - 데이터 그리드 레벨 변경이 사이드바 트리에 반영 안됨
   - 드래그 앤 드롭 후 구조 동기화 안됨

## 해결 방안 및 구현

### 1. 다크 테마 숫자 입력 수정

#### 파일: `dark-grid-complete.css`
```css
/* ContentEditable fields - especially numeric ones */
.editable-field,
.editable-number,
.editable-currency,
[contenteditable="true"],
span[contenteditable="true"],
td [contenteditable="true"] {
    color: #ffffff !important;
}
```

#### 파일: `mbom-ui.js`
- 숫자 입력 시 이벤트 전파 중지 (stopPropagation)
- 키보드 단축키와 충돌 방지

#### 파일: `advanced-level-manager.js`, `keyboard-shortcuts.js`
- 편집 중인 요소 확인 로직 추가
- contentEditable이나 input 요소 편집 시 단축키 비활성화

### 2. 행 위치 저장 구현

#### 파일: `advanced-level-manager.js`
- LocalStorage를 사용한 테이블 상태 저장
- 드래그 앤 드롭 후 상태 유지
- `saveTableState()`, `restoreTableState()` 메서드 구현

### 3. 양방향 동기화 시스템

#### 초기 시도들 (실패)
1. **tree-grid-sync.js**: MutationObserver 기반 - 이벤트 루프 문제
2. **level-sync-manager.js + level-warning-system.js**: 너무 복잡한 경고 시스템
3. **bom-state-manager.js + connectors**: 중앙 상태 관리 - 기존 시스템과 충돌

#### 최종 해결책

##### 파일: `simple-sync.js`
```javascript
class SimpleSync {
    constructor() {
        this.syncing = false;  // 동기화 중 플래그로 루프 방지
        this.init();
    }

    listenToLevelChanges() {
        // levelChanged 이벤트 수신
        document.addEventListener('levelChanged', (e) => {
            if (this.syncing) return;
            const { partNumber, newLevel, row } = e.detail;
            this.updateTreeLevel(partNumber, newLevel);
        });
    }

    updateTreeLevel(partNumber, newLevel) {
        this.syncing = true;
        // 트리 노드 업데이트 로직
        setTimeout(() => {
            this.syncing = false;
        }, 100);
    }
}
```

##### 파일: `advanced-level-manager.js` (수정)
```javascript
// 드래그 종료 시 트리 동기화 추가
row.addEventListener('dragend', () => {
    row.style.opacity = '';
    this.draggedRow = null;

    // 드래그 인디케이터 제거
    document.querySelectorAll('.drag-over').forEach(r => {
        r.classList.remove('drag-over');
    });

    // 트리와 동기화
    this.syncToTree();
});

// 트리 동기화 메서드
syncToTree() {
    // Map을 사용한 중복 제거
    const dataMap = new Map();
    const collectDataItems = (items) => {
        items.forEach(item => {
            dataMap.set(String(item.id), item);
            if (item.children && item.children.length > 0) {
                collectDataItems(item.children);
            }
        });
    };
    collectDataItems(window.mbomUI.core.data);

    // 새로운 데이터 순서 생성 (중복 없이)
    const newDataOrder = [];
    const usedIds = new Set();

    rows.forEach(row => {
        const rowId = String(row.dataset.id);
        if (rowId && dataMap.has(rowId) && !usedIds.has(rowId)) {
            newDataOrder.push(dataMap.get(rowId));
            usedIds.add(rowId);
        }
    });

    // core.data 업데이트
    if (newDataOrder.length > 0) {
        window.mbomUI.core.data.length = 0;  // 배열 비우기
        newDataOrder.forEach(item => {
            window.mbomUI.core.data.push(item);
        });

        // 트리만 재렌더링
        window.mbomUI.renderTree();
    }
}
```

## 핵심 기능

### 1. 레벨 변경 동기화
- Alt + 화살표키로 레벨 변경
- 숫자키(0-9)로 직접 레벨 설정
- 변경 시 자동으로 트리 업데이트

### 2. 드래그 앤 드롭 동기화
- 데이터 그리드 행 드래그로 순서 변경
- 드래그 종료 시 자동으로 트리 구조 업데이트
- 중복 방지 로직으로 깨끗한 동기화

### 3. 이벤트 루프 방지
- `syncing` 플래그 사용
- `updateOrigin` 체크
- `dragInitialized` 플래그로 중복 이벤트 방지

## 파일 구조

```
mbom-system/
├── src/
│   ├── css/
│   │   └── dark-grid-complete.css    # 다크 테마 스타일
│   ├── js/
│   │   ├── advanced-level-manager.js  # 레벨 관리 및 드래그 동기화
│   │   ├── simple-sync.js            # 간단한 동기화 시스템
│   │   ├── mbom-ui.js                # UI 관리
│   │   └── keyboard-shortcuts.js     # 키보드 단축키
│   └── pages/
│       └── index.html                 # 메인 페이지
```

## 주요 이벤트 플로우

1. **레벨 변경 플로우**
   ```
   사용자 입력 (Alt+화살표/숫자키)
   ↓
   advanced-level-manager.js: setRowLevel()
   ↓
   levelChanged 이벤트 발생
   ↓
   simple-sync.js: updateTreeLevel()
   ↓
   트리 노드 업데이트
   ```

2. **드래그 앤 드롭 플로우**
   ```
   행 드래그 시작
   ↓
   행 위치 변경
   ↓
   dragend 이벤트
   ↓
   advanced-level-manager.js: syncToTree()
   ↓
   mbomUI.core.data 재정렬
   ↓
   mbomUI.renderTree()
   ↓
   트리 재렌더링
   ```

## 테스트 방법

### 브라우저 콘솔 명령어
```javascript
// 수동 동기화
simpleSync.manualSync()

// 현재 상태 확인
console.log(window.mbomUI.core.data)

// 레벨 변경 테스트
window.advancedLevelManager.setRowLevel(row, 2)
```

### 키보드 단축키
- **Alt + ←/→**: 레벨 감소/증가
- **Alt + ↑/↓**: 행 위치 이동
- **0-9**: 직접 레벨 설정
- **Tab/Shift+Tab**: 레벨 증가/감소

## 문제 해결 기록

### 1. 행 복제 버그
- **원인**: drag-sync.js와 advanced-level-manager.js 중복 이벤트
- **해결**: drag-sync.js 제거, 중복 방지 플래그 추가

### 2. 트리 중복 표시
- **원인**: 단순 push로 인한 데이터 중복
- **해결**: Map과 Set을 사용한 중복 제거, 배열 완전 교체

### 3. 이벤트 루프
- **원인**: 양방향 이벤트 전파
- **해결**: syncing 플래그, updateOrigin 체크

## 향후 개선 사항

1. **성능 최적화**
   - Virtual DOM 적용 고려
   - 대량 데이터 처리 최적화

2. **사용자 경험**
   - 드래그 중 시각적 피드백 강화
   - 애니메이션 효과 추가

3. **안정성**
   - 에러 핸들링 강화
   - 롤백 기능 구현

## 참고 사항

- 기존 시스템(mbomUI)의 구조를 최대한 유지
- 하위 항목 추가 기능의 동기화 패턴 참고
- 이벤트 기반 아키텍처 사용

---

작성일: 2024년
작성자: Claude AI Assistant
프로젝트: Multi-BOM Management System